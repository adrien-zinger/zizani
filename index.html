<html>

<header>
    <style>
        ul {
            list-style: none;
            padding: 0;
        }

        ul li.red::before {
            color: red;
        }

        ul li.green::before {
            color: green;
        }

        ul li.info {
            color: rgb(126, 92, 51);
        }

        ul li.info::before {
            color: rgb(126, 92, 51);
        }

        ul li::before {
            content: "➜";
            font-size: 9;
            color: black;
            display: inline-block;
        }
    </style>
</header>

<body style="height: 100%;">
    <form id="connectionForm" onsubmit="onFormSubmit(); return false;">
        <input id="pseudo" type="text" placeholder="anonymous" />
        <input id="room" type="text" placeholder="salon de discussion" />
        <input id="server" type="text" placeholder="chemin (optionnel)" />
        <input type="submit" hidden />
    </form>

    <div id="roomView" style="visibility: hidden;">
        <ul id="outputView" style="height: fit-content; max-height: 80vh; width: 100vw; overflow: auto;"></ul>
        <form id="messageForm" onsubmit="onMessageSubmit(); return false;"
            style="max-height: 20vh; width: 80vw; position: absolute; bottom: 10px;">
            <input id="message" type="text" autocomplete="off" style="width: 80%" disabled />
            <input type="submit" hidden />
        </form>
    </div>

    <script src="script.js"></script>

    <script>

        function onFormSubmit() {
            let roomElt = document.getElementById("room");
            let serverElt = document.getElementById("server");
            if (roomElt.value === "")
                alert("Renseigner le salon est indispensable");
            let pseudo = document.getElementById("pseudo");
            if (pseudo.value !== "")
                setNickName(pseudo.value);
            join(roomElt.value, serverElt.value === "" ? "wss://adalrozin.xyz:8532" : serverElt.value);
        }

        function onMessageSubmit() {
            let msg = document.getElementById("message");
            if (msg.value === "/call") {
                msg.value = "";
                pushMessage("info: vous êtes sur le point de passer un appel audio." +
                    " Cette fonctionnalité est encore en développement", "info");
                pushMessage("info: veuillez patienter, nous connectons les pairs entre eux. Celà peut prendre quelques secondes", "info");
                startCall();
                return;
            }
            send(msg.value);
            pushMessage(`moi: ${msg.value}`);
            msg.value = "";
        }

        const outputView = document.getElementById("outputView");

        function pushMessage(msg, className) {
            let newDiv = document.createElement('li');
            newDiv.innerText = msg;
            if (className) newDiv.className = className;
            outputView.appendChild(newDiv);
        }

        setOnMessages((/** @type {ChatMessage} */ message) => {
            pushMessage(message.content);
        });

        let status = 0; // idle

        onPrepareWsProposal = () => {
            document.getElementById("connectionForm").style.visibility = "hidden";
            document.getElementById("roomView").style.visibility = "visible";
            pushMessage("info: recherche du salon", "info");
        };

        onSendWsProposal = () => {
            if (status != 1)
                pushMessage("info: attente des participants", "info");
        };

        /** Afficher que le client est connecté */
        function activateRoom() {
            pushMessage("info: vous êtes connecté", "info");
            document.getElementById("message").disabled = false;
        }

        onConnectionToRoomDone = () => {
            if (status != 1) {
                activateRoom();
                status = 1;
            }
        };

        onWsProposalAnswerOpened = () => {
            if (status != 1) {
                activateRoom();
                status = 1;
            }
        };

        getAudioElt = (label) => {
            console.log("create audio elt");
            let audio = document.createElement('audio');
            let mute = document.createElement('button');
            let volume = document.createElement('input');
            let ctnr = document.createElement('div');
            volume.type = "range";
            volume.max = 100;
            volume.value = 100;
            audio.autoplay = true;
            let play = true;
            mute.onclick = () => {
                if (play) {
                    console.log("pause");
                    audio.pause();
                    play = false;
                } else {
                    audio.play().then(() => console.log("play"));
                    play = true;
                }
            };
            volume.oninput = (e) => {
                audio.volume = e.target.value / 100;
            };
            mute.innerText = "mute";
            ctnr.appendChild(audio);
            ctnr.appendChild(mute);
            ctnr.appendChild(volume);
            outputView.appendChild(ctnr);
            return audio;
        };
    </script>
</body>

</html>